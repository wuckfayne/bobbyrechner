<!doctype html>
<html lang="de">
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Bobby's D√ºngerrechner</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;color:#e4e7eb;min-height:100vh;padding:20px;position:relative;overflow-x:hidden;transition:all 0.5s ease}
body.dark{background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 50%,#0f1419 100%)}
body.light{background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 50%,#bcccdc 100%);color:#1e293b}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;transition:opacity 0.5s}
body.dark::before{background:radial-gradient(circle at 20% 50%,rgba(120,119,198,0.1),transparent 50%),radial-gradient(circle at 80% 80%,rgba(72,187,120,0.08),transparent 50%)}
body.light::before{background:radial-gradient(circle at 20% 50%,rgba(139,92,246,0.05),transparent 50%),radial-gradient(circle at 80% 80%,rgba(6,182,212,0.05),transparent 50%)}
.container{max-width:1400px;margin:0 auto;position:relative;z-index:1}
h2{background:linear-gradient(135deg,#8b5cf6,#ec4899,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;margin-bottom:8px;font-size:2.5em;font-weight:800;letter-spacing:-1px}
.version{text-align:center;color:#64748b;margin-bottom:35px;font-size:0.9em;font-weight:500}
.header-controls{position:absolute;top:20px;right:20px;display:flex;gap:12px;z-index:10}
.theme-toggle,.options-btn{background:rgba(139,92,246,0.2);border:2px solid rgba(139,92,246,0.3);color:#8b5cf6;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;transition:all 0.3s;font-size:1.2em}
.theme-toggle:hover,.options-btn:hover{background:rgba(139,92,246,0.3);transform:scale(1.05)}
.section{backdrop-filter:blur(20px);border-radius:16px;padding:24px;margin-bottom:24px;transition:transform 0.3s,box-shadow 0.3s,background 0.5s,border 0.5s}
body.dark .section{background:rgba(30,41,59,0.7);border:1px solid rgba(255,255,255,0.06);box-shadow:0 8px 32px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05)}
body.light .section{background:rgba(255,255,255,0.9);border:1px solid rgba(139,92,246,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.08),inset 0 1px 0 rgba(255,255,255,0.5)}
.section:hover{transform:translateY(-2px)}
body.dark .section:hover{box-shadow:0 12px 40px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.08)}
body.light .section:hover{box-shadow:0 8px 30px rgba(0,0,0,0.12),inset 0 1px 0 rgba(255,255,255,0.8)}
h3{font-size:1.1em;margin-bottom:18px;text-transform:uppercase;letter-spacing:2px;font-weight:700;position:relative;padding-left:12px}
body.dark h3{color:#f1f5f9}
body.light h3{color:#1e293b}
h3::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:20px;background:linear-gradient(180deg,#8b5cf6,#06b6d4);border-radius:2px}
.table-container{overflow-x:auto;border-radius:12px;margin-top:16px}
table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden}
body.dark table{background:rgba(15,23,42,0.6)}
body.light table{background:rgba(255,255,255,0.5)}
th{padding:14px;text-align:center;font-weight:700;text-transform:uppercase;font-size:0.7em;letter-spacing:1.5px;border-bottom:2px solid rgba(139,92,246,0.3)}
body.dark th{background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(6,182,212,0.15));color:#94a3b8}
body.light th{background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(6,182,212,0.1));color:#475569}
td{padding:12px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03)}
body.dark td{color:#cbd5e1}
body.light td{color:#334155;border-bottom:1px solid rgba(0,0,0,0.05)}
body.dark tr:hover td{background:rgba(139,92,246,0.08)}
body.light tr:hover td{background:rgba(139,92,246,0.05)}
td:first-child{text-align:left;font-weight:600}
body.dark td:first-child{color:#8b5cf6}
body.light td:first-child{color:#7c3aed}
.water-row td:first-child{color:#06b6d4 !important}
body.light .water-row td:first-child{color:#0ea5e9 !important}
.nutrient-value{font-weight:600;font-size:0.95em}
.nutrient-unit{font-size:0.7em;color:#64748b;margin-left:2px}
input,select{padding:10px 12px;border-radius:10px;font-size:0.95em;width:100%;transition:all 0.3s;font-weight:500}
body.dark input,body.dark select{background:rgba(15,23,42,0.8);color:#e4e7eb;border:1px solid rgba(139,92,246,0.2)}
body.light input,body.light select{background:rgba(255,255,255,0.9);color:#1e293b;border:1px solid rgba(139,92,246,0.3)}
input:focus,select:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.15)}
body.dark input:focus,body.dark select:focus{background:rgba(15,23,42,0.95)}
body.light input:focus,body.light select:focus{background:rgba(255,255,255,1)}
.fert-row{display:grid;grid-template-columns:2fr 120px 60px 40px;gap:12px;align-items:center;margin-bottom:12px;padding:14px;border-radius:12px;transition:all 0.3s}
body.dark .fert-row{background:rgba(30,41,59,0.5);border:1px solid rgba(139,92,246,0.15)}
body.light .fert-row{background:rgba(255,255,255,0.6);border:1px solid rgba(139,92,246,0.2)}
.fert-row:hover{transform:translateX(4px)}
body.dark .fert-row:hover{background:rgba(30,41,59,0.7);border-color:rgba(139,92,246,0.3)}
body.light .fert-row:hover{background:rgba(255,255,255,0.8);border-color:rgba(139,92,246,0.4)}
.fert-row .unit{color:#06b6d4;font-weight:700;text-align:center;font-size:0.9em}
.delete-btn{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;font-size:1.2em;font-weight:bold;transition:all 0.3s;display:flex;align-items:center;justify-content:center;width:40px;height:40px}
.delete-btn:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);transform:scale(1.1)}
.add-btn{background:linear-gradient(135deg,#8b5cf6,#06b6d4);color:#fff;border:none;padding:14px 28px;border-radius:12px;cursor:pointer;font-weight:700;margin-top:12px;transition:all 0.3s;display:inline-flex;align-items:center;gap:10px;text-transform:uppercase;letter-spacing:1px;font-size:0.9em}
.add-btn:hover{transform:translateY(-3px);background:linear-gradient(135deg,#7c3aed,#0891b2)}
.reset-btn{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;padding:14px 28px;border-radius:12px;cursor:pointer;font-weight:700;margin-top:12px;transition:all 0.3s;display:inline-flex;align-items:center;gap:10px;text-transform:uppercase;letter-spacing:1px;font-size:0.9em}
.reset-btn:hover{transform:translateY(-3px);background:linear-gradient(135deg,#eab308,#ca8a04)}
.pdf-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:14px 28px;border-radius:12px;cursor:pointer;font-weight:700;transition:all 0.3s;display:inline-flex;align-items:center;gap:10px;text-transform:uppercase;letter-spacing:1px;font-size:0.9em}
.pdf-btn:hover{transform:translateY(-3px);background:linear-gradient(135deg,#059669,#047857)}
.result-row td{font-weight:800;border-top:2px solid rgba(34,197,94,0.3);font-size:1.05em}
body.dark .result-row{background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(16,185,129,0.15))!important}
body.light .result-row{background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(16,185,129,0.1))!important}
body.dark .result-row td{color:#34d399}
body.light .result-row td{color:#059669}
.dosierung-summary{background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(6,182,212,0.1));border-radius:12px;padding:20px;margin-top:20px;border:1px solid rgba(139,92,246,0.2)}
body.dark .dosierung-summary{background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(6,182,212,0.1))}
body.light .dosierung-summary{background:linear-gradient(135deg,rgba(139,92,246,0.05),rgba(6,182,212,0.05))}
.dosierung-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.dosierung-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:8px}
body.light .dosierung-item{background:rgba(0,0,0,0.03)}
.dosierung-name{font-weight:600}
body.dark .dosierung-name{color:#8b5cf6}
body.light .dosierung-name{color:#7c3aed}
.dosierung-menge{font-weight:700;color:#06b6d4}
.verdunnung-tool{margin:20px 0;padding:15px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(139,92,246,0.2)}
body.light .verdunnung-tool{background:rgba(0,0,0,0.03)}
.verdunnung-input{display:flex;align-items:center;gap:10px;margin-bottom:15px}
.verdunnung-input input{flex:1;max-width:120px;text-align:center}
.verdunnung-label{font-weight:600;color:#06b6d4}
.nutrient-overview{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}
.nutrient-group{padding:12px;border-radius:8px;background:rgba(255,255,255,0.03)}
body.light .nutrient-group{background:rgba(0,0,0,0.02)}
.nutrient-group-title{font-weight:700;margin-bottom:8px;font-size:0.9em;text-transform:uppercase;letter-spacing:1px;color:#8b5cf6}
.nutrient-line{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:0.85em;border-bottom:1px solid rgba(255,255,255,0.05)}
body.light .nutrient-line{border-bottom:1px solid rgba(0,0,0,0.05)}
.nutrient-line:last-child{border-bottom:none}
.nutrient-name{color:#cbd5e1}
body.light .nutrient-name{color:#64748b}
.nutrient-value-verdunnung{font-weight:600}
.current-value{color:#10b981}
.diluted-value{color:#0ea5e9}
.settings-bar{display:flex;align-items:center;gap:12px;margin-top:15px;flex-wrap:wrap}
.settings-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:8px}
body.light .settings-item{background:rgba(0,0,0,0.03)}
.settings-label{font-size:0.8em;font-weight:600;color:#06b6d4;white-space:nowrap}
.settings-input{width:80px;text-align:center;padding:6px 8px;font-size:0.9em}
.options-menu{position:absolute;top:60px;right:20px;background:inherit;border-radius:12px;padding:16px;min-width:200px;border:1px solid rgba(139,92,246,0.3);display:none}
body.dark .options-menu{background:rgba(30,41,59,0.95)}
body.light .options-menu{background:rgba(255,255,255,0.98)}
.options-item{padding:12px 16px;cursor:pointer;border-radius:8px;transition:all 0.2s;margin-bottom:4px}
.options-item:hover{background:rgba(139,92,246,0.2)}
.options-item:last-child{margin-bottom:0}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:2000;display:none}
.modal-content{background:inherit;border-radius:16px;padding:24px;max-width:90%;max-height:90%;overflow-y:auto;border:1px solid rgba(139,92,246,0.3)}
body.dark .modal-content{background:rgba(30,41,59,0.95)}
body.light .modal-content{background:rgba(255,255,255,0.98)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-close{background:none;border:none;font-size:1.5em;cursor:pointer;color:#64748b;padding:4px}
.modal-close:hover{color:#ef4444}
.nutrient-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px}
.nutrient-input{display:flex;flex-direction:column}
.nutrient-input label{font-size:0.75em;margin-bottom:4px;font-weight:600}
.fert-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.05)}
body.light .fert-item{background:rgba(0,0,0,0.03)}
.fert-item-name{font-weight:600}
.delete-fert-btn{background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8em}
.search-container{position:relative;margin-bottom:15px}
.search-input{width:100%;padding:12px 45px 12px 16px;border-radius:12px;font-size:1em}
body.dark .search-input{background:rgba(15,23,42,0.9);color:#e4e7eb;border:1px solid rgba(139,92,246,0.3)}
body.light .search-input{background:rgba(255,255,255,0.95);color:#1e293b;border:1px solid rgba(139,92,246,0.4)}
.search-clear{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:#64748b;cursor:pointer;font-size:1.2em;padding:4px}
.search-clear:hover{color:#ef4444}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:inherit;border-radius:0 0 12px 12px;max-height:200px;overflow-y:auto;z-index:100;margin-top:2px}
body.dark .autocomplete-list{background:rgba(30,41,59,0.95);border:1px solid rgba(139,92,246,0.3)}
body.light .autocomplete-list{background:rgba(255,255,255,0.98);border:1px solid rgba(139,92,246,0.4)}
.autocomplete-item{padding:12px 16px;cursor:pointer;transition:all 0.2s;border-bottom:1px solid rgba(255,255,255,0.05)}
body.dark .autocomplete-item{border-bottom:1px solid rgba(255,255,255,0.08)}
body.light .autocomplete-item{border-bottom:1px solid rgba(0,0,0,0.08)}
.autocomplete-item:hover{background:rgba(139,92,246,0.2)}
.autocomplete-item:last-child{border-bottom:none}
.autocomplete-highlight{color:#8b5cf6;font-weight:700}
.instagram-link{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#8b5cf6,#ec4899,#06b6d4);color:#fff;padding:12px 16px;border-radius:50px;text-decoration:none;font-weight:700;display:flex;align-items:center;gap:8px;z-index:1000;transition:all 0.3s;font-size:0.9em}
.instagram-link:hover{transform:translateY(-3px);color:#fff}
body.light .instagram-link{box-shadow:0 4px 20px rgba(139,92,246,0.3)}
.dosierung-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.section{animation:fadeIn 0.5s ease-out}
@media(max-width:1024px){.fert-row{grid-template-columns:1fr;gap:10px}.nutrient-grid{grid-template-columns:1fr}}
@media(max-width:640px){h2{font-size:2em}.header-controls{position:relative;top:auto;right:auto;justify-content:flex-end;margin-bottom:20px}.instagram-link{bottom:15px;right:15px;padding:10px 14px;font-size:0.8em}.nutrient-overview{grid-template-columns:1fr}.settings-bar{flex-direction:column;align-items:stretch}.settings-item{justify-content:space-between}.dosierung-header{flex-direction:column;align-items:stretch}}
</style>
</head>
<body class="dark">
<div class='header-controls'>
    <button onclick='toggleTheme()' id='theme-btn' class='theme-toggle'>üåô</button>
    <button onclick='toggleOptions()' class='options-btn'>‚öôÔ∏è Optionen</button>
    <div id='options-menu' class='options-menu'>
        <div class='options-item' onclick='showWaterModal()'>üíß Wasserwerte</div>
        <div class='options-item' onclick='showAddFertModal()'>‚ûï D√ºnger hinzuf√ºgen</div>
        <div class='options-item' onclick='showDeleteFertModal()'>üóëÔ∏è D√ºnger l√∂schen</div>
    </div>
</div>

<div class='container'>
<h2>üå± Bobby's D√ºngerrechner üå±</h2>
<p class='version'>Version 2.0 (2025-11-12) - Mit Verd√ºnnungstool & PDF Export</p>

<div class='section'>
<h3>üß™ D√ºnger</h3>
<div class="search-container">
    <input type="text" id="fert-search" class="search-input" placeholder="üîç D√ºnger suchen... (z.B. 'Hesi', 'PK', 'Calcium')" oninput="filterFerts()">
    <button class="search-clear" onclick="clearSearch()">√ó</button>
    <div id="autocomplete-list" class="autocomplete-list" style="display:none"></div>
</div>
<div id="fert-container"></div>

<div class="settings-bar">
    <button class="add-btn" onclick="addFertRow()">‚ûï D√ºnger hinzuf√ºgen</button>
    <button class="reset-btn" onclick="resetAllFerts()">üîÑ Zur√ºcksetzen</button>
    <div class="settings-item">
        <span class="settings-label">Osmose:</span>
        <input type="number" id="ro" value="0" min="0" max="100" oninput="calc()" class="settings-input">
        <span class="settings-label">%</span>
    </div>
</div>
</div>

<div class='section'>
<h3>üìä Makron√§hrstoffe</h3>
<div class='table-container'>
<table>
<thead>
<tr><th>D√ºnger</th><th>Dosierung</th><th>N</th><th>P</th><th>K</th><th>Ca</th><th>Mg</th><th>S</th></tr>
</thead>
<tbody id='macro-body'></tbody>
</table>
</div>
</div>

<div class='section'>
<h3>üî¨ Mikron√§hrstoffe</h3>
<div class='table-container'>
<table>
<thead>
<tr><th>D√ºnger</th><th>Dosierung</th><th>B</th><th>Cu</th><th>Fe</th><th>Mn</th><th>Mo</th><th>Zn</th><th>Si</th></tr>
</thead>
<tbody id='micro-body'></tbody>
</table>
</div>
</div>

<div class='section' id='dosierung-section' style='display:none'>
<h3>üß™ Dosierungs-Zusammenfassung</h3>
<div class='dosierung-summary'>
    <div class="dosierung-header">
        <div class="settings-item">
            <span class="settings-label">Volumen:</span>
            <input type="number" id="vol" value="10" step="0.1" min="0" oninput="calc()" class="settings-input">
            <span class="settings-label">Liter</span>
        </div>
        <button class="pdf-btn" onclick="generatePDF()">üìÑ PDF Export</button>
    </div>
    
    <div id="verdunnung-tool" class="verdunnung-tool" style="display:none">
        <div class="verdunnung-input">
            <span class="verdunnung-label">üß™ Verd√ºnnungstool:</span>
            <span>+</span>
            <input type="number" id="verdunnung-liter" value="0" step="0.1" min="0" oninput="updateVerdunnung()">
            <span>Liter Osmose-Wasser hinzuf√ºgen</span>
        </div>
        
        <div class="nutrient-overview">
            <div class="nutrient-group">
                <div class="nutrient-group-title">üìä Makron√§hrstoffe (mg/L)</div>
                <div id="macro-overview"></div>
            </div>
            <div class="nutrient-group">
                <div class="nutrient-group-title">üî¨ Mikron√§hrstoffe (mg/L)</div>
                <div id="micro-overview"></div>
            </div>
        </div>
    </div>
    
    <div class='dosierung-list' id='dosierung-list'></div>
</div>
</div>

</div>

<a href="https://www.instagram.com/thebobbygrow/" target="_blank" class="instagram-link">üì∑ @thebobbygrow</a>

<!-- Modal Fenster -->
<div id="water-modal" class="modal">
<div class="modal-content" style="max-width:500px">
    <div class="modal-header">
        <h3>üíß Leitungswasser - N√§hrstoffe</h3>
        <button class="modal-close" onclick="closeModal('water-modal')">√ó</button>
    </div>
    <h4>Makron√§hrstoffe (mg/L)</h4>
    <div class="nutrient-grid">
        <div class="nutrient-input"><label>N</label><input id="water_n" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>P</label><input id="water_p" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>K</label><input id="water_k" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>Ca</label><input id="water_ca" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>Mg</label><input id="water_mg" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>S</label><input id="water_s" type="number" step="0.1" value="0"></div>
    </div>
    <h4>Mikron√§hrstoffe (mg/L)</h4>
    <div class="nutrient-grid">
        <div class="nutrient-input"><label>B</label><input id="water_b" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Cu</label><input id="water_cu" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Fe</label><input id="water_fe" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Mn</label><input id="water_mn" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Mo</label><input id="water_mo" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Zn</label><input id="water_zn" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Si</label><input id="water_si" type="number" step="0.1" value="0"></div>
    </div>
    <button class="add-btn" onclick="saveWaterValues()" style="width:100%;margin-top:20px">üíæ Wasserwerte speichern</button>
</div>
</div>

<div id="add-fert-modal" class="modal">
<div class="modal-content" style="max-width:600px">
    <div class="modal-header">
        <h3>‚ûï Eigenen D√ºnger erstellen</h3>
        <button class="modal-close" onclick="closeModal('add-fert-modal')">√ó</button>
    </div>
    <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;font-weight:600">D√ºnger-Name</label>
        <input type="text" id="new-fert-name" placeholder="z.B. Mein Eigen-D√ºnger">
        <label style="display:block;margin-bottom:8px;font-weight:600">Einheit</label>
        <select id="new-fert-unit">
            <option value="ml">ml (Fl√ºssigd√ºnger)</option>
            <option value="g">g (Pulverd√ºnger)</option>
        </select>
    </div>
    
    <h4>Makron√§hrstoffe (in %)</h4>
    <div class="nutrient-grid">
        <div class="nutrient-input"><label>N (% N)</label><input id="new-fert-n" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>P (% P‚ÇÇO‚ÇÖ)</label><input id="new-fert-p" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>K (% K‚ÇÇO)</label><input id="new-fert-k" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>Ca (% CaO)</label><input id="new-fert-ca" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>Mg (% MgO)</label><input id="new-fert-mg" type="number" step="0.1" value="0"></div>
        <div class="nutrient-input"><label>S (% S)</label><input id="new-fert-s" type="number" step="0.1" value="0"></div>
    </div>
    
    <h4>Mikron√§hrstoffe (in %)</h4>
    <div class="nutrient-grid">
        <div class="nutrient-input"><label>B (% B)</label><input id="new-fert-b" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Cu (% Cu)</label><input id="new-fert-cu" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Fe (% Fe)</label><input id="new-fert-fe" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Mn (% Mn)</label><input id="new-fert-mn" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Mo (% Mo)</label><input id="new-fert-mo" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Zn (% Zn)</label><input id="new-fert-zn" type="number" step="0.01" value="0"></div>
        <div class="nutrient-input"><label>Si (% Si)</label><input id="new-fert-si" type="number" step="0.1" value="0"></div>
    </div>
    
    <button class="add-btn" onclick="saveNewFert()" style="width:100%;margin-top:20px">üíæ D√ºnger speichern</button>
</div>
</div>

<div id="delete-fert-modal" class="modal">
<div class="modal-content" style="max-width:500px">
    <div class="modal-header">
        <h3>üóëÔ∏è D√ºnger l√∂schen</h3>
        <button class="modal-close" onclick="closeModal('delete-fert-modal')">√ó</button>
    </div>
    <p style="margin-bottom:20px;color:#94a3b8">W√§hle die D√ºnger aus, die du l√∂schen m√∂chtest:</p>
    <div id="delete-fert-list"></div>
    <button class="reset-btn" onclick="deleteSelectedFerts()" style="width:100%;margin-top:20px">üóëÔ∏è Ausgew√§hlte D√ºnger l√∂schen</button>
</div>
</div>

<script>
// PDF.js Bibliothek einbinden
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
script.onload = () => console.log('PDF.js geladen');
document.head.appendChild(script);

// Oxid-Umrechnungsfaktoren
const OXID_FACTORS = {
    p: 0.4364, k: 0.8301, ca: 0.7147, mg: 0.6030
};

// N√§hrstoff-Konstanten
const MICRO_NUTRIENTS = ['b', 'cu', 'fe', 'mn', 'mo', 'zn', 'si'];

let fertCounter = 0;
let userFerts = [];
let waterValues = {n:0,p:0,k:0,ca:0,mg:0,s:0,b:0,cu:0,fe:0,mn:0,mo:0,zn:0,si:0};
let searchTimeout;
let ALL_FERTS = [];
let filteredFerts = [];
let currentNutrientTotals = {};

// PDF Export Funktion
function generatePDF() {
    if (typeof jsPDF === 'undefined') {
        showNotification('‚ùå PDF-Bibliothek wird noch geladen... Bitte versuche es in ein paar Sekunden erneut.', 'error');
        return;
    }

    showNotification('üìÑ PDF wird generiert...', 'info');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // PDF Inhalt
    const date = new Date().toLocaleString('de-DE');
    const vol = document.getElementById('vol').value || '10';
    const ro = document.getElementById('ro').value || '0';
    const tap = 100 - parseInt(ro);
    
    // Header
    doc.setFillColor(139, 92, 246);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.text('üå± Bobby\'s D√ºngerrechner', 105, 15, { align: 'center' });
    doc.setFontSize(12);
    doc.text('N√§hrstoffanalyse Report', 105, 25, { align: 'center' });
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(8);
    doc.text(`Erstellt am: ${date}`, 105, 35, { align: 'center' });
    
    // Einstellungen
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    let yPos = 50;
    doc.setFillColor(240, 240, 240);
    doc.rect(10, yPos, 190, 15, 'F');
    doc.text(`‚öôÔ∏è Berechnungseinstellungen: ${vol} Liter | Osmose: ${ro}% | Leitungswasser: ${tap}%`, 15, yPos + 10);
    
    // Makron√§hrstoffe Tabelle
    yPos += 25;
    doc.setFontSize(12);
    doc.setTextColor(139, 92, 246);
    doc.text('üìä Makron√§hrstoffe (mg/L)', 15, yPos);
    
    const macroTable = document.getElementById('macro-body');
    if (macroTable) {
        yPos += 10;
        let rows = macroTable.querySelectorAll('tr');
        const headers = ['D√ºnger', 'Dosierung', 'N', 'P', 'K', 'Ca', 'Mg', 'S'];
        
        // Tabellen-Header
        doc.setFontSize(8);
        doc.setTextColor(255, 255, 255);
        doc.setFillColor(100, 100, 150);
        doc.rect(10, yPos, 190, 8, 'F');
        let xPos = 12;
        headers.forEach((header, index) => {
            const width = index === 0 ? 60 : 18;
            doc.text(header, xPos, yPos + 6);
            xPos += width;
        });
        
        // Tabellen-Inhalt
        yPos += 8;
        doc.setTextColor(0, 0, 0);
        rows.forEach((row, rowIndex) => {
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            
            const cells = row.querySelectorAll('td');
            const isWaterRow = row.classList.contains('water-row');
            const isResultRow = row.classList.contains('result-row');
            
            if (isWaterRow) doc.setFillColor(200, 230, 255);
            else if (isResultRow) doc.setFillColor(200, 255, 200);
            else doc.setFillColor(255, 255, 255);
            
            doc.rect(10, yPos, 190, 8, 'F');
            
            xPos = 12;
            cells.forEach((cell, cellIndex) => {
                const width = cellIndex === 0 ? 60 : 18;
                const text = cell.textContent.trim();
                doc.text(text, xPos, yPos + 6);
                xPos += width;
            });
            
            yPos += 8;
        });
    }
    
    // Mikron√§hrstoffe Tabelle
    yPos += 15;
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setTextColor(139, 92, 246);
    doc.text('üî¨ Mikron√§hrstoffe (mg/L)', 15, yPos);
    
    const microTable = document.getElementById('micro-body');
    if (microTable) {
        yPos += 10;
        let rows = microTable.querySelectorAll('tr');
        const headers = ['D√ºnger', 'Dosierung', 'B', 'Cu', 'Fe', 'Mn', 'Mo', 'Zn', 'Si'];
        
        // Tabellen-Header
        doc.setFontSize(8);
        doc.setTextColor(255, 255, 255);
        doc.setFillColor(100, 100, 150);
        doc.rect(10, yPos, 190, 8, 'F');
        let xPos = 12;
        headers.forEach((header, index) => {
            const width = index === 0 ? 60 : 14;
            doc.text(header, xPos, yPos + 6);
            xPos += width;
        });
        
        // Tabellen-Inhalt
        yPos += 8;
        doc.setTextColor(0, 0, 0);
        rows.forEach((row, rowIndex) => {
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            
            const cells = row.querySelectorAll('td');
            const isWaterRow = row.classList.contains('water-row');
            const isResultRow = row.classList.contains('result-row');
            
            if (isWaterRow) doc.setFillColor(200, 230, 255);
            else if (isResultRow) doc.setFillColor(200, 255, 200);
            else doc.setFillColor(255, 255, 255);
            
            doc.rect(10, yPos, 190, 8, 'F');
            
            xPos = 12;
            cells.forEach((cell, cellIndex) => {
                const width = cellIndex === 0 ? 60 : 14;
                const text = cell.textContent.trim();
                doc.text(text, xPos, yPos + 6);
                xPos += width;
            });
            
            yPos += 8;
        });
    }
    
    // Dosierungs-Zusammenfassung
    const dosierungList = document.getElementById('dosierung-list');
    if (dosierungList && dosierungList.children.length > 0) {
        yPos += 15;
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.setTextColor(139, 92, 246);
        doc.text('üß™ Dosierungs-Zusammenfassung', 15, yPos);
        
        yPos += 10;
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        Array.from(dosierungList.children).forEach(item => {
            const name = item.querySelector('.dosierung-name').textContent;
            const menge = item.querySelector('.dosierung-menge').textContent;
            doc.text(`‚Ä¢ ${name}: ${menge}`, 20, yPos);
            yPos += 6;
        });
    }
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Seite ${i} von ${pageCount}`, 105, 290, { align: 'center' });
        doc.text('üå± Erstellt mit Bobby\'s D√ºngerrechner', 105, 295, { align: 'center' });
    }
    
    // PDF speichern
    const filename = `Bobby_Duengerrechner_${date.replace(/[/:\\]/g, '-')}.pdf`;
    doc.save(filename);
    showNotification('‚úÖ PDF erfolgreich erstellt!', 'success');
}

// Benachrichtigungs-System
function showNotification(message, type = 'info') {
    const colors = {
        info: '#06b6d4',
        success: '#10b981', 
        warning: '#f59e0b',
        error: '#ef4444'
    };
    
    document.querySelectorAll('.notification').forEach(el => el.remove());
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: ${colors[type]}; color: white; padding: 12px 20px; 
        border-radius: 8px; z-index: 10000; font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Daten laden
async function loadAllFertsFromCSV() {
    try {
        const response = await fetch('./data/fertilizers.csv');
        if (!response.ok) throw new Error('CSV nicht gefunden');
        const csvText = await response.text();
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(';').map(h => h.trim());
        
        return lines.slice(1).filter(line => line.trim()).map(line => {
            const values = line.split(';').map(v => v.trim());
            const fert = {};
            headers.forEach((header, index) => {
                let value = values[index] || '0';
                if (header !== 'name' && header !== 'unit') {
                    value = parseFloat(value.replace(',', '.')) || 0;
                }
                fert[header] = value;
            });
            return fert;
        });
    } catch (error) {
        console.log("CSV nicht geladen, nutze leere Liste");
        showNotification('‚ö†Ô∏è Standard-D√ºngerliste konnte nicht geladen werden', 'warning');
        return [];
    }
}

function getAllFerts() {
    return [...ALL_FERTS, ...userFerts];
}

// D√ºnger-Zeilen Management
function saveFertRows() {
    const fertRows = document.querySelectorAll('.fert-row');
    const savedRows = [];
    fertRows.forEach(row => {
        const select = row.querySelector('select');
        const input = row.querySelector('input');
        const unitSpan = row.querySelector('.unit');
        savedRows.push({
            fertIndex: select.value,
            dose: input.value,
            unit: unitSpan.textContent.replace('/L', '')
        });
    });
    localStorage.setItem('savedFertRows', JSON.stringify(savedRows));
}

function loadFertRows() {
    const saved = localStorage.getItem('savedFertRows');
    if (!saved) {
        addFertRow();
        return;
    }
    try {
        const savedRows = JSON.parse(saved);
        const container = document.getElementById('fert-container');
        container.innerHTML = '';
        fertCounter = 0;
        savedRows.forEach(rowData => {
            const row = document.createElement('div');
            row.className = 'fert-row';
            row.id = 'fert-row-' + fertCounter;
            const allFerts = getAllFerts();
            let options = '<option value="">--D√ºnger w√§hlen--</option>';
            allFerts.forEach((f, i) => {
                const selected = i.toString() === rowData.fertIndex ? 'selected' : '';
                options += `<option value="${i}" ${selected}>${f.name}</option>`;
            });
            row.innerHTML = `
                <select onchange="updateUnit(this)">${options}</select>
                <input type="number" step="0.01" value="${rowData.dose}" min="0" oninput="calc()">
                <span class="unit">${rowData.unit}/L</span>
                <button onclick="removeFertRow('${row.id}')" class="delete-btn" title="D√ºnger entfernen">‚úï</button>
            `;
            container.appendChild(row);
            fertCounter++;
        });
        if (savedRows.length === 0) addFertRow();
    } catch (error) {
        console.error('Fehler beim Laden der D√ºnger-Zeilen:', error);
        addFertRow();
    }
}

function updateFertStorage() {
    saveFertRows();
    calc();
}

// Validierung
function validateInputs() {
    const vol = parseFloat(document.getElementById('vol').value) || 0;
    const ro = parseFloat(document.getElementById('ro').value) || 0;
    
    if (vol <= 0) {
        showNotification("‚ùå Bitte gib ein g√ºltiges Volumen gr√∂√üer 0 Liter ein", 'error');
        return false;
    }
    if (vol > 10000) {
        showNotification("‚ùå Volumen sollte unter 10.000 Liter bleiben", 'error');
        return false;
    }
    if (ro < 0 || ro > 100) {
        showNotification("‚ùå Osmose-Wasser Anteil muss zwischen 0% und 100% liegen", 'error');
        return false;
    }
    return true;
}

// UI-Funktionen
function toggleOptions() {
    const menu = document.getElementById('options-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function showWaterModal() {
    closeAllModals();
    loadWaterValues();
    document.getElementById('water-modal').style.display = 'flex';
}

function showAddFertModal() {
    closeAllModals();
    document.getElementById('add-fert-modal').style.display = 'flex';
}

function showDeleteFertModal() {
    closeAllModals();
    loadDeleteFertList();
    document.getElementById('delete-fert-modal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    document.getElementById('options-menu').style.display = 'none';
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.options-btn') && !e.target.closest('.options-menu')) {
        document.getElementById('options-menu').style.display = 'none';
    }
    if (e.target.classList.contains('modal')) {
        closeAllModals();
    }
});

// Wasserwerte
function saveWaterValues() {
    waterValues = {
        n: parseFloat(document.getElementById('water_n').value) || 0,
        p: parseFloat(document.getElementById('water_p').value) || 0,
        k: parseFloat(document.getElementById('water_k').value) || 0,
        ca: parseFloat(document.getElementById('water_ca').value) || 0,
        mg: parseFloat(document.getElementById('water_mg').value) || 0,
        s: parseFloat(document.getElementById('water_s').value) || 0,
        b: parseFloat(document.getElementById('water_b').value) || 0,
        cu: parseFloat(document.getElementById('water_cu').value) || 0,
        fe: parseFloat(document.getElementById('water_fe').value) || 0,
        mn: parseFloat(document.getElementById('water_mn').value) || 0,
        mo: parseFloat(document.getElementById('water_mo').value) || 0,
        zn: parseFloat(document.getElementById('water_zn').value) || 0,
        si: parseFloat(document.getElementById('water_si').value) || 0
    };
    localStorage.setItem('waterValues', JSON.stringify(waterValues));
    closeModal('water-modal');
    showNotification('üíß Wasserwerte erfolgreich gespeichert', 'success');
    calc();
}

function loadWaterValues() {
    const saved = localStorage.getItem('waterValues');
    if (saved) {
        waterValues = JSON.parse(saved);
        document.getElementById('water_n').value = waterValues.n;
        document.getElementById('water_p').value = waterValues.p;
        document.getElementById('water_k').value = waterValues.k;
        document.getElementById('water_ca').value = waterValues.ca;
        document.getElementById('water_mg').value = waterValues.mg;
        document.getElementById('water_s').value = waterValues.s;
        document.getElementById('water_b').value = waterValues.b;
        document.getElementById('water_cu').value = waterValues.cu;
        document.getElementById('water_fe').value = waterValues.fe;
        document.getElementById('water_mn').value = waterValues.mn;
        document.getElementById('water_mo').value = waterValues.mo;
        document.getElementById('water_zn').value = waterValues.zn;
        document.getElementById('water_si').value = waterValues.si;
    }
}

// D√ºnger Management
function saveNewFert() {
    const name = document.getElementById('new-fert-name').value.trim();
    const unit = document.getElementById('new-fert-unit').value;
    
    if (!name) {
        showNotification('‚ùå Bitte einen Namen f√ºr den D√ºnger eingeben!', 'error');
        return;
    }
    
    const allFerts = getAllFerts();
    if (allFerts.some(fert => fert.name.toLowerCase() === name.toLowerCase())) {
        showNotification('‚ùå Ein D√ºnger mit diesem Namen existiert bereits!', 'error');
        return;
    }
    
    const newFert = {
        name: name, unit: unit,
        n: (parseFloat(document.getElementById('new-fert-n').value) || 0) * 10,
        p: (parseFloat(document.getElementById('new-fert-p').value) || 0) * 10 * OXID_FACTORS.p,
        k: (parseFloat(document.getElementById('new-fert-k').value) || 0) * 10 * OXID_FACTORS.k,
        ca: (parseFloat(document.getElementById('new-fert-ca').value) || 0) * 10 * OXID_FACTORS.ca,
        mg: (parseFloat(document.getElementById('new-fert-mg').value) || 0) * 10 * OXID_FACTORS.mg,
        s: (parseFloat(document.getElementById('new-fert-s').value) || 0) * 10,
        b: (parseFloat(document.getElementById('new-fert-b').value) || 0) * 10,
        cu: (parseFloat(document.getElementById('new-fert-cu').value) || 0) * 10,
        fe: (parseFloat(document.getElementById('new-fert-fe').value) || 0) * 10,
        mn: (parseFloat(document.getElementById('new-fert-mn').value) || 0) * 10,
        mo: (parseFloat(document.getElementById('new-fert-mo').value) || 0) * 10,
        zn: (parseFloat(document.getElementById('new-fert-zn').value) || 0) * 10,
        si: (parseFloat(document.getElementById('new-fert-si').value) || 0) * 10
    };
    
    userFerts.push(newFert);
    localStorage.setItem('userFerts', JSON.stringify(userFerts));
    
    document.getElementById('new-fert-name').value = '';
    document.querySelectorAll('#add-fert-modal input[type="number"]').forEach(input => {
        input.value = '0';
    });
    
    closeModal('add-fert-modal');
    updateFertStorage();
    showNotification('‚úÖ D√ºnger erfolgreich gespeichert!', 'success');
}

function loadDeleteFertList() {
    const container = document.getElementById('delete-fert-list');
    if (userFerts.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#64748b">Keine eigenen D√ºnger vorhanden</p>';
        return;
    }
    let html = '';
    userFerts.forEach((fert, index) => {
        html += `
            <div class="fert-item">
                <span class="fert-item-name">${fert.name}</span>
                <input type="checkbox" id="delete-fert-${index}" value="${index}">
            </div>
        `;
    });
    container.innerHTML = html;
}

function deleteSelectedFerts() {
    const indicesToDelete = [];
    userFerts.forEach((fert, index) => {
        const checkbox = document.getElementById(`delete-fert-${index}`);
        if (checkbox && checkbox.checked) {
            indicesToDelete.push(index);
        }
    });
    
    if (indicesToDelete.length === 0) {
        showNotification('‚ùå Bitte w√§hle D√ºnger aus, die gel√∂scht werden sollen!', 'error');
        return;
    }
    
    indicesToDelete.sort((a, b) => b - a).forEach(index => {
        userFerts.splice(index, 1);
    });
    
    localStorage.setItem('userFerts', JSON.stringify(userFerts));
    closeModal('delete-fert-modal');
    updateFertStorage();
    showNotification(`üóëÔ∏è ${indicesToDelete.length} D√ºnger erfolgreich gel√∂scht!`, 'success');
}

function loadUserFerts() {
    const saved = localStorage.getItem('userFerts');
    if (saved) userFerts = JSON.parse(saved);
}

function resetAllFerts() {
    if (!confirm('M√∂chtest du wirklich alle D√ºnger zur√ºcksetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        return;
    }
    
    const container = document.getElementById('fert-container');
    container.innerHTML = '';
    fertCounter = 0;
    addFertRow();
    localStorage.removeItem('savedFertRows');
    showNotification('üîÑ Alle D√ºnger zur√ºckgesetzt', 'info');
    calc();
}

// Suchfunktionen
function filterFerts() {
    const searchTerm = document.getElementById('fert-search').value.toLowerCase().trim();
    const autocompleteList = document.getElementById('autocomplete-list');
    
    if (searchTerm.length === 0) {
        autocompleteList.style.display = 'none';
        filteredFerts = [];
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const allFerts = getAllFerts();
        filteredFerts = allFerts.filter(fert => 
            fert.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredFerts.length === 0) {
            autocompleteList.innerHTML = '<div class="autocomplete-item">Keine D√ºnger gefunden</div>';
            autocompleteList.style.display = 'block';
            return;
        }
        
        let html = '';
        filteredFerts.forEach((fert, index) => {
            const name = fert.name;
            const lowerName = name.toLowerCase();
            const startIndex = lowerName.indexOf(searchTerm);
            
            if (startIndex !== -1) {
                const before = name.substring(0, startIndex);
                const match = name.substring(startIndex, startIndex + searchTerm.length);
                const after = name.substring(startIndex + searchTerm.length);
                html += `
                    <div class="autocomplete-item" onclick="selectFert(${index})">
                        ${before}<span class="autocomplete-highlight">${match}</span>${after}
                    </div>
                `;
            } else {
                html += `<div class="autocomplete-item" onclick="selectFert(${index})">${name}</div>`;
            }
        });
        autocompleteList.innerHTML = html;
        autocompleteList.style.display = 'block';
    }, 300);
}

function selectFert(fertIndex) {
    if (fertIndex >= 0 && fertIndex < filteredFerts.length) {
        const selectedFert = filteredFerts[fertIndex];
        const allFerts = getAllFerts();
        const globalIndex = allFerts.findIndex(fert => fert.name === selectedFert.name);
        if (globalIndex !== -1) addFertRowWithSelection(globalIndex);
    }
    document.getElementById('fert-search').value = '';
    document.getElementById('autocomplete-list').style.display = 'none';
    filteredFerts = [];
}

function addFertRowWithSelection(fertIndex) {
    const allFerts = getAllFerts();
    if (fertIndex >= allFerts.length) return;
    
    const container = document.getElementById('fert-container');
    const row = document.createElement('div');
    row.className = 'fert-row';
    row.id = 'fert-row-' + fertCounter;
    
    let options = '<option value="">--D√ºnger w√§hlen--</option>';
    allFerts.forEach((f,i) => {
        const selected = i === fertIndex ? 'selected' : '';
        options += `<option value="${i}" ${selected}>${f.name}</option>`;
    });
    
    row.innerHTML = `
        <select onchange="updateUnit(this)">${options}</select>
        <input type="number" step="0.01" value="1.0" min="0" oninput="updateFertStorage()">
        <span class="unit">${allFerts[fertIndex].unit}/L</span>
        <button onclick="removeFertRow('${row.id}')" class="delete-btn" title="D√ºnger entfernen">‚úï</button>
    `;
    container.appendChild(row);
    fertCounter++;
    updateFertStorage();
}

function clearSearch() {
    document.getElementById('fert-search').value = '';
    document.getElementById('autocomplete-list').style.display = 'none';
    filteredFerts = [];
}

// D√ºnger-Zeilen
function addFertRow() {
    const container = document.getElementById('fert-container');
    const row = document.createElement('div');
    row.className = 'fert-row';
    row.id = 'fert-row-' + fertCounter;
    
    const allFerts = getAllFerts();
    let options = '<option value="">--D√ºnger w√§hlen--</option>';
    allFerts.forEach((f,i) => {
        options += `<option value="${i}">${f.name}</option>`;
    });
    
    row.innerHTML = `
        <select onchange="updateUnit(this)">${options}</select>
        <input type="number" step="0.01" value="1.0" min="0" oninput="updateFertStorage()">
        <span class="unit">ml/L</span>
        <button onclick="removeFertRow('${row.id}')" class="delete-btn" title="D√ºnger entfernen">‚úï</button>
    `;
    container.appendChild(row);
    fertCounter++;
    updateFertStorage();
}

function updateUnit(selectElement) {
    const row = selectElement.closest('.fert-row');
    const unitSpan = row.querySelector('.unit');
    const selectedIndex = parseInt(selectElement.value);
    const allFerts = getAllFerts();
    
    if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < allFerts.length) {
        unitSpan.textContent = allFerts[selectedIndex].unit + '/L';
    } else {
        unitSpan.textContent = 'ml/L';
    }
    updateFertStorage();
}

function removeFertRow(id) {
    const row = document.getElementById(id);
    if(row) {
        row.remove();
        updateFertStorage();
        showNotification('üóëÔ∏è D√ºnger entfernt', 'info');
    }
}

// Berechnungen - OPTIMIERTE VERSION
function updateVerdunnung() {
    const verdunnungLiter = parseFloat(document.getElementById('verdunnung-liter').value) || 0;
    if (verdunnungLiter < 0) {
        document.getElementById('verdunnung-liter').value = 0;
        return;
    }
    
    const vol = parseFloat(document.getElementById('vol').value) || 0;
    const totalVolume = vol + verdunnungLiter;
    
    let macroHTML = '';
    const macroNutrients = ['n', 'p', 'k', 'ca', 'mg', 's'];
    const macroNames = {'n': 'N', 'p': 'P', 'k': 'K', 'ca': 'Ca', 'mg': 'Mg', 's': 'S'};
    
    macroNutrients.forEach(nutrient => {
        const currentValue = currentNutrientTotals[nutrient] || 0;
        const dilutedValue = verdunnungLiter > 0 ? (currentValue * vol) / totalVolume : currentValue;
        macroHTML += `
            <div class="nutrient-line">
                <span class="nutrient-name">${macroNames[nutrient]}</span>
                <span>
                    <span class="nutrient-value-verdunnung current-value">${currentValue.toFixed(1)}</span>
                    ${verdunnungLiter > 0 ? ` ‚Üí <span class="nutrient-value-verdunnung diluted-value">${dilutedValue.toFixed(1)}</span>` : ''}
                </span>
            </div>
        `;
    });
    document.getElementById('macro-overview').innerHTML = macroHTML;
    
    let microHTML = '';
    const microNames = {'b': 'B', 'cu': 'Cu', 'fe': 'Fe', 'mn': 'Mn', 'mo': 'Mo', 'zn': 'Zn', 'si': 'Si'};
    
    MICRO_NUTRIENTS.forEach(nutrient => {
        const currentValue = currentNutrientTotals[nutrient] || 0;
        const dilutedValue = verdunnungLiter > 0 ? (currentValue * vol) / totalVolume : currentValue;
        microHTML += `
            <div class="nutrient-line">
                <span class="nutrient-name">${microNames[nutrient]}</span>
                <span>
                    <span class="nutrient-value-verdunnung current-value">${currentValue.toFixed(nutrient === 'si' ? 1 : 2)}</span>
                    ${verdunnungLiter > 0 ? ` ‚Üí <span class="nutrient-value-verdunnung diluted-value">${dilutedValue.toFixed(nutrient === 'si' ? 1 : 2)}</span>` : ''}
                </span>
            </div>
        `;
    });
    document.getElementById('micro-overview').innerHTML = microHTML;
}

function calc() {
    if (!validateInputs()) return;
    
    const vol = parseFloat(document.getElementById('vol').value) || 0;
    const ro = parseFloat(document.getElementById('ro').value) || 0;
    
    document.querySelectorAll('.fert-row input[type="number"]').forEach(input => {
        if (input.value < 0) input.value = 0;
    });
    
    const tap = 100 - ro;
    const fertRows = document.querySelectorAll('.fert-row');
    const used = [];
    const dosierungList = [];
    const allFerts = getAllFerts();
    
    // D√ºnger sammeln
    fertRows.forEach(row => {
        const select = row.querySelector('select');
        const input = row.querySelector('input');
        const idx = parseInt(select.value);
        const dosePerLiter = parseFloat(input.value) || 0;
        
        if(!isNaN(idx) && dosePerLiter > 0 && idx < allFerts.length) {
            const f = allFerts[idx];
            const totalDose = dosePerLiter * vol;
            
            used.push({
                name: f.name, dose: dosePerLiter, totalDose: totalDose, unit: f.unit,
                n: dosePerLiter * f.n, p: dosePerLiter * f.p, k: dosePerLiter * f.k,
                ca: dosePerLiter * f.ca, mg: dosePerLiter * f.mg, s: dosePerLiter * f.s,
                b: dosePerLiter * f.b, cu: dosePerLiter * f.cu, fe: dosePerLiter * f.fe,
                mn: dosePerLiter * f.mn, mo: dosePerLiter * f.mo, zn: dosePerLiter * f.zn,
                si: dosePerLiter * f.si
            });
            
            dosierungList.push({ name: f.name, totalDose: totalDose, unit: f.unit });
        }
    });
    
    // N√§hrstoffe berechnen - OPTIMIERT
    const sum = {n:0,p:0,k:0,ca:0,mg:0,s:0,b:0,cu:0,fe:0,mn:0,mo:0,zn:0,si:0};
    used.forEach(u => {
        Object.keys(sum).forEach(key => {
            sum[key] += u[key] || 0;
        });
    });
    
    localStorage.setItem('vol', document.getElementById('vol').value);
    localStorage.setItem('ro', document.getElementById('ro').value);
    
    // Wasserwerte berechnen - OPTIMIERT
    const w = {};
    Object.keys(waterValues).forEach(key => {
        w[key] = waterValues[key] * tap / 100;
    });
    
    // Gesamtn√§hrstoffe
    currentNutrientTotals = {};
    Object.keys(sum).forEach(key => {
        currentNutrientTotals[key] = w[key] + sum[key];
    });
    
    // Makron√§hrstoffe-Tabelle
    let macroHTML = '';
    const hasWaterMacro = tap > 0 && Object.values(w).some(val => val > 0);
    
    if(hasWaterMacro){
        macroHTML += `<tr class="water-row"><td>Leitungswasser (${tap.toFixed(0)}%)</td><td>-</td>
            <td><span class="nutrient-value">${w.n.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.p.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.k.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.ca.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.mg.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.s.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
    }
    
    used.forEach(u => {
        macroHTML += `<tr><td>${u.name}</td><td>${u.dose.toFixed(2)} ${u.unit}/L</td>
            <td><span class="nutrient-value">${u.n.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${u.p.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${u.k.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${u.ca.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${u.mg.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${u.s.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
    });
    
    macroHTML += `<tr class='result-row'><td><b>GESAMT</b></td><td>-</td>
        <td><span class="nutrient-value">${(w.n+sum.n).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
        <td><span class="nutrient-value">${(w.p+sum.p).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
        <td><span class="nutrient-value">${(w.k+sum.k).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
        <td><span class="nutrient-value">${(w.ca+sum.ca).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
        <td><span class="nutrient-value">${(w.mg+sum.mg).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td>
        <td><span class="nutrient-value">${(w.s+sum.s).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
    
    document.getElementById('macro-body').innerHTML = macroHTML;
    
    // Mikron√§hrstoffe-Tabelle - JETZT MIT FILTER! ‚úÖ
    let microHTML = '';
    const hasWaterMicro = tap > 0 && MICRO_NUTRIENTS.some(nutrient => w[nutrient] > 0);
    
    if(hasWaterMicro){
        microHTML += `<tr class="water-row"><td>Leitungswasser (${tap.toFixed(0)}%)</td><td>-</td>
            <td><span class="nutrient-value">${w.b.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.cu.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.fe.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.mn.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.mo.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.zn.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${w.si.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
    }
    
    // NUR D√ºnger mit Mikron√§hrstoffen anzeigen! ‚úÖ
    used.forEach(u => {
        const hasMicro = MICRO_NUTRIENTS.some(nutrient => u[nutrient] > 0);
        if (hasMicro) {
            microHTML += `<tr><td>${u.name}</td><td>${u.dose.toFixed(2)} ${u.unit}/L</td>
                <td><span class="nutrient-value">${u.b.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.cu.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.fe.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.mn.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.mo.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.zn.toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
                <td><span class="nutrient-value">${u.si.toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
        }
    });
    
    const hasAnyMicro = hasWaterMicro || used.some(u => MICRO_NUTRIENTS.some(nutrient => u[nutrient] > 0));
    
    if(hasAnyMicro){
        microHTML += `<tr class='result-row'><td><b>GESAMT</b></td><td>-</td>
            <td><span class="nutrient-value">${(w.b+sum.b).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.cu+sum.cu).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.fe+sum.fe).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.mn+sum.mn).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.mo+sum.mo).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.zn+sum.zn).toFixed(2)}</span><span class="nutrient-unit">mg/L</span></td>
            <td><span class="nutrient-value">${(w.si+sum.si).toFixed(1)}</span><span class="nutrient-unit">mg/L</span></td></tr>`;
    } else {
        microHTML = '<tr><td colspan="9" style="text-align:center;color:#888">Keine Mikron√§hrstoffe vorhanden</td></tr>';
    }
    
    document.getElementById('micro-body').innerHTML = microHTML;
    
    // Dosierungs-Zusammenfassung
    if(dosierungList.length > 0) {
        document.getElementById('dosierung-section').style.display = 'block';
        document.getElementById('verdunnung-tool').style.display = 'block';
        document.getElementById('verdunnung-liter').value = '0';
        updateVerdunnung();
        
        let dosierungHTML = '';
        dosierungList.forEach(item => {
            dosierungHTML += `
                <div class="dosierung-item">
                    <span class="dosierung-name">${item.name}</span>
                    <span class="dosierung-menge">${item.totalDose.toFixed(1)} ${item.unit}</span>
                </div>
            `;
        });
        document.getElementById('dosierung-list').innerHTML = dosierungHTML;
    } else {
        document.getElementById('dosierung-section').style.display = 'none';
        document.getElementById('verdunnung-tool').style.display = 'none';
    }
}

// Theme
function toggleTheme() {
    const body = document.body;
    const btn = document.getElementById('theme-btn');
    const isDark = body.classList.contains('dark');
    
    if(isDark) {
        body.classList.remove('dark');
        body.classList.add('light');
        btn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'light');
    } else {
        body.classList.remove('light');
        body.classList.add('dark');
        btn.textContent = 'üåô';
        localStorage.setItem('theme', 'dark');
    }
}

function loadInputs() {
    const vol = localStorage.getItem('vol');
    const ro = localStorage.getItem('ro');
    if(vol !== null) document.getElementById('vol').value = vol;
    if(ro !== null) document.getElementById('ro').value = ro;
}

// Initialisierung - SICHERE VERSION ohne Datenverlust
window.onload = async function() {
    const currentVersion = '2.0';
    const savedVersion = localStorage.getItem('appVersion');
    
    // Nur Version updaten falls n√∂tig, keine Daten l√∂schen!
    if (savedVersion !== currentVersion) {
        localStorage.setItem('appVersion', currentVersion);
        console.log('App Version updated to', currentVersion);
    }
    
    ALL_FERTS = await loadAllFertsFromCSV();
    
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'light') {
        document.body.classList.remove('dark');
        document.body.classList.add('light');
        document.getElementById('theme-btn').textContent = '‚òÄÔ∏è';
    }
    
    loadInputs();
    loadUserFerts();
    loadWaterValues();
    loadFertRows();
    calc();
    
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 0) this.value = 0;
        });
    });
    
    showNotification('üå± D√ºngerrechner erfolgreich geladen!', 'success');
};
</script>
</body>
</html>
